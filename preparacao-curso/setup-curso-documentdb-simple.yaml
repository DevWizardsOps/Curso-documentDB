AWSTemplateFormatVersion: '2010-09-09'
Description: 'Ambiente para Curso DocumentDB - Instancias EC2 + Usuarios IAM'

Parameters:
  PrefixoAluno:
    Type: String
    Default: 'aluno'
    Description: 'Prefixo para nomes dos alunos'
    
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: 'VPC onde criar as instancias'
    
  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: 'Subnet publica para as instancias'
    
  AllowedCIDR:
    Type: String
    Default: '0.0.0.0/0'
    Description: 'CIDR permitido para SSH'
    
  KeyPairName:
    Type: String
    Description: 'Nome da chave SSH existente (a mesma sera usada para todas as instancias)'
    
  ConsolePasswordSecret:
    Type: String
    Description: 'Nome do secret no Secrets Manager contendo a senha do console'

Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-0c02fb55956c7d316
    us-east-2:
      AMI: ami-0f924dc71d44d23e2
    us-west-1:
      AMI: ami-0d9858aa3c6322f73
    us-west-2:
      AMI: ami-008fe2fc65df48dac
    eu-west-1:
      AMI: ami-01dd271720c1ba44f
    eu-central-1:
      AMI: ami-0f454ec961da9a046

Resources:
  # Security Group para alunos
  AlunosSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-alunos-sg'
      GroupDescription: 'Security Group para instancias dos alunos'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedCIDR
          Description: 'SSH access'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-alunos-sg'

  # Security Group para DocumentDB
  DocumentDBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-documentdb-sg'
      GroupDescription: 'Security Group para DocumentDB'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 27017
          ToPort: 27017
          SourceSecurityGroupId: !Ref AlunosSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-documentdb-sg'

  # IAM Group para alunos
  CursoDocumentDBGroup:
    Type: AWS::IAM::Group
    Properties:
      GroupName: !Sub '${AWS::StackName}-students'
      Policies:
        - PolicyName: DocumentDBCoursePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # DocumentDB - Acesso completo
              - Effect: Allow
                Action:
                  - 'docdb:*'
                Resource: '*'
              
              # EC2 - Consultas e gerenciamento de Security Groups
              - Effect: Allow
                Action:
                  - 'ec2:DescribeVpcs'
                  - 'ec2:DescribeSubnets'
                  - 'ec2:DescribeSecurityGroups'
                  - 'ec2:DescribeAvailabilityZones'
                  - 'ec2:DescribeInstances'
                  - 'ec2:DescribeAccountAttributes'
                  - 'ec2:DescribeVpcAttribute'
                  - 'ec2:DescribeSubnetAttribute'
                  - 'ec2:CreateSecurityGroup'
                  - 'ec2:AuthorizeSecurityGroupIngress'
                  - 'ec2:AuthorizeSecurityGroupEgress'
                  - 'ec2:RevokeSecurityGroupIngress'
                  - 'ec2:RevokeSecurityGroupEgress'
                  - 'ec2:DeleteSecurityGroup'
                  - 'ec2:CreateTags'
                  - 'ec2:ModifySecurityGroupRules'
                Resource: '*'
              
              # CloudWatch - Monitoramento e metricas
              - Effect: Allow
                Action:
                  - 'cloudwatch:GetMetricStatistics'
                  - 'cloudwatch:ListMetrics'
                  - 'cloudwatch:GetMetricData'
                  - 'cloudwatch:DescribeAlarms'
                  - 'cloudwatch:PutMetricAlarm'
                  - 'cloudwatch:DeleteAlarms'
                  - 'cloudwatch:PutDashboard'
                  - 'cloudwatch:GetDashboard'
                  - 'cloudwatch:ListDashboards'
                  - 'cloudwatch:DeleteDashboards'
                Resource: '*'
              
              # CloudWatch Logs - Visualizacao de logs
              - Effect: Allow
                Action:
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeLogStreams'
                  - 'logs:GetLogEvents'
                  - 'logs:FilterLogEvents'
                Resource: '*'
              
              # S3 - Buckets do curso e backups dos alunos
              - Effect: Allow
                Action:
                  - 's3:CreateBucket'
                  - 's3:ListBucket'
                  - 's3:GetObject'
                  - 's3:PutObject'
                  - 's3:DeleteObject'
                  - 's3:GetBucketLocation'
                  - 's3:PutBucketVersioning'
                  - 's3:GetBucketVersioning'
                  - 's3:PutLifecycleConfiguration'
                  - 's3:GetLifecycleConfiguration'
                  - 's3:PutBucketPolicy'
                  - 's3:GetBucketPolicy'
                  - 's3:ListAllMyBuckets'
                Resource: 
                  - !Sub 'arn:aws:s3:::${AWS::StackName}-*'
                  - !Sub 'arn:aws:s3:::${AWS::StackName}-*/*'
                  - 'arn:aws:s3:::*-docdb-backups-*'
                  - 'arn:aws:s3:::*-docdb-backups-*/*'
                  - 'arn:aws:s3:::*-lab-*'
                  - 'arn:aws:s3:::*-lab-*/*'
              
              # EventBridge - Para automa√ß√£o b√°sica
              - Effect: Allow
                Action:
                  - 'events:PutRule'
                  - 'events:DeleteRule'
                  - 'events:PutTargets'
                  - 'events:RemoveTargets'
                  - 'events:DescribeRule'
                  - 'events:ListRules'
                  - 'events:ListTargetsByRule'
                Resource: '*'
                Condition:
                  StringLike:
                    'events:RuleName': !Sub '${AWS::StackName}-*'
              
              # Lambda - Funcoes basicas para automacao
              - Effect: Allow
                Action:
                  - 'lambda:CreateFunction'
                  - 'lambda:DeleteFunction'
                  - 'lambda:InvokeFunction'
                  - 'lambda:UpdateFunctionCode'
                  - 'lambda:UpdateFunctionConfiguration'
                  - 'lambda:GetFunction'
                  - 'lambda:ListFunctions'
                Resource: !Sub 'arn:aws:lambda:*:${AWS::AccountId}:function:${AWS::StackName}-*'
              
              # KMS - Apenas visualizacao de chaves
              - Effect: Allow
                Action:
                  - 'kms:Describe*'
                  - 'kms:List*'
                Resource: '*'
              
              # SNS - Notificacoes e alertas
              - Effect: Allow
                Action:
                  - 'sns:CreateTopic'
                  - 'sns:DeleteTopic'
                  - 'sns:Subscribe'
                  - 'sns:Unsubscribe'
                  - 'sns:ListTopics'
                  - 'sns:ListSubscriptions'
                  - 'sns:SetTopicAttributes'
                  - 'sns:GetTopicAttributes'
                  - 'sns:Publish'
                Resource: '*'
              
              # RDS - Alias para DocumentDB (alguns comandos usam namespace rds)
              - Effect: Allow
                Action:
                  - 'rds:DescribeDBClusters'
                  - 'rds:DescribeDBInstances'
                  - 'rds:DescribeDBClusterSnapshots'
                  - 'rds:DescribeDBSnapshots'
                  - 'rds:ListTagsForResource'
                Resource: '*'
              
              # STS - Identificacao do usuario
              - Effect: Allow
                Action:
                  - 'sts:GetCallerIdentity'
                Resource: '*'

  # IAM Role para instancias EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # S3 Bucket para laboratorios
  LabsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-labs-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # Recursos do Aluno 01
  Aluno01User:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}01'
      Groups:
        - !Ref CursoDocumentDBGroup

  Aluno01LoginProfile:
    Type: AWS::IAM::LoginProfile
    Properties:
      UserName: !Ref Aluno01User
      Password: 'Extractta@2026'
      PasswordResetRequired: false

  Aluno01AccessKey:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno01User

  Aluno01Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            yum update -y
            yum install -y aws-cli git
            
            # Instalar MongoDB Shell
            cat > /etc/yum.repos.d/mongodb-org-7.0.repo << 'EOF'
            [mongodb-org-7.0]
            name=MongoDB Repository
            baseurl=https://repo.mongodb.org/yum/amazon/2/mongodb-org/7.0/x86_64/
            gpgcheck=1
            enabled=1
            gpgkey=https://www.mongodb.org/static/pgp/server-7.0.asc
            EOF
            yum install -y mongodb-mongosh
            
            # Criar usu√°rio do aluno
            useradd -m -s /bin/bash ${PrefixoAluno}01
            echo "${PrefixoAluno}01 ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
            
            # Copiar chave SSH do ec2-user para o aluno (permite SSH direto)
            mkdir -p /home/${PrefixoAluno}01/.ssh
            cp /home/ec2-user/.ssh/authorized_keys /home/${PrefixoAluno}01/.ssh/authorized_keys
            chown -R ${PrefixoAluno}01:${PrefixoAluno}01 /home/${PrefixoAluno}01/.ssh
            chmod 700 /home/${PrefixoAluno}01/.ssh
            chmod 600 /home/${PrefixoAluno}01/.ssh/authorized_keys
            
            # Instalar Node.js
            curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
            yum install -y nodejs
            
            # Instalar Python 3 e pip
            yum install -y python3 python3-pip
            
            # Instalar Terraform
            yum install -y yum-utils
            yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
            yum install -y terraform
            
            # Configurar AWS CLI para o aluno
            sudo -u ${PrefixoAluno}01 aws configure set aws_access_key_id ${AccessKey}
            sudo -u ${PrefixoAluno}01 aws configure set aws_secret_access_key ${SecretKey}
            sudo -u ${PrefixoAluno}01 aws configure set default.region ${AWS::Region}
            sudo -u ${PrefixoAluno}01 aws configure set default.output json
            
            # Baixar certificado SSL do DocumentDB
            cd /home/${PrefixoAluno}01
            wget https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem
            chown ${PrefixoAluno}01:${PrefixoAluno}01 global-bundle.pem
            
            # Instalar depend√™ncias Python
            sudo -u ${PrefixoAluno}01 pip3 install --user boto3
            
            # Criar diret√≥rio para laborat√≥rios
            sudo -u ${PrefixoAluno}01 mkdir -p /home/${PrefixoAluno}01/documentdb-labs
            
            # Criar arquivo de boas-vindas com instru√ß√µes
            cat > /home/${PrefixoAluno}01/BEM-VINDO.txt << 'WELCOME'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë              BEM-VINDO AO CURSO DOCUMENTDB                   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Ol√° ${PrefixoAluno}01!

Seu ambiente est√° configurado e pronto para uso.

üìã INFORMA√á√ïES DO AMBIENTE:
  - Usu√°rio Linux: ${PrefixoAluno}01
  - Usu√°rio AWS IAM: ${AWS::StackName}-${PrefixoAluno}01
  - Regi√£o AWS: ${AWS::Region}
  - Chave SSH: ${KeyPairName}

üîß FERRAMENTAS INSTALADAS:
  ‚úì AWS CLI (j√° configurado com suas credenciais)
  ‚úì MongoDB Shell (mongosh)
  ‚úì Node.js 18.x
  ‚úì Python 3 + pip
  ‚úì Terraform
  ‚úì Git

üìÅ DIRET√ìRIOS:
  - Laborat√≥rios: ~/documentdb-labs
  - Certificado SSL: ~/global-bundle.pem

üöÄ PRIMEIROS PASSOS:
  1. Teste o AWS CLI:
     aws sts get-caller-identity

  2. Liste recursos dispon√≠veis:
     aws docdb describe-db-clusters

  3. Acesse o diret√≥rio de labs:
     cd ~/documentdb-labs

üí° DICAS:
  - Suas credenciais AWS j√° est√£o configuradas
  - Use 'mongosh' para conectar ao DocumentDB
  - O certificado SSL est√° em ~/global-bundle.pem

üìö DOCUMENTA√á√ÉO:
  - AWS DocumentDB: https://docs.aws.amazon.com/documentdb/
  - MongoDB Shell: https://docs.mongodb.com/mongodb-shell/

Bom curso! üéì
WELCOME
            
            chown ${PrefixoAluno}01:${PrefixoAluno}01 /home/${PrefixoAluno}01/BEM-VINDO.txt
            
            # Criar arquivo .bashrc customizado
            cat >> /home/${PrefixoAluno}01/.bashrc << 'BASHRC'

# Customiza√ß√µes do Curso DocumentDB
export PS1='\[\033[01;32m\]\u@documentdb-lab\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '

# Aliases √∫teis
alias ll='ls -lah'
alias labs='cd ~/documentdb-labs'
alias awsid='aws sts get-caller-identity'

# Mostrar boas-vindas no primeiro login
if [ -f ~/BEM-VINDO.txt ] && [ ! -f ~/.welcome_shown ]; then
    cat ~/BEM-VINDO.txt
    touch ~/.welcome_shown
fi

echo ""
echo "üí° Digite 'cat ~/BEM-VINDO.txt' para ver as informa√ß√µes do ambiente"
echo ""
BASHRC
            
            chown ${PrefixoAluno}01:${PrefixoAluno}01 /home/${PrefixoAluno}01/.bashrc
            
            # Ajustar permiss√µes
            chown -R ${PrefixoAluno}01:${PrefixoAluno}01 /home/${PrefixoAluno}01/
            
            # Marcar setup como completo
            echo "Setup completo em $(date)" > /home/${PrefixoAluno}01/setup-complete.txt
            chown ${PrefixoAluno}01:${PrefixoAluno}01 /home/${PrefixoAluno}01/setup-complete.txt
          - AccessKey: !Ref Aluno01AccessKey
            SecretKey: !GetAtt Aluno01AccessKey.SecretAccessKey
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}01-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 02
  Aluno02User:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}02'
      Groups:
        - !Ref CursoDocumentDBGroup

  Aluno02LoginProfile:
    Type: AWS::IAM::LoginProfile
    Properties:
      UserName: !Ref Aluno02User
      Password: 'Extractta@2026'
      PasswordResetRequired: false

  Aluno02AccessKey:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno02User

  Aluno02Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            yum update -y
            yum install -y aws-cli git
            
            # Instalar MongoDB Shell
            cat > /etc/yum.repos.d/mongodb-org-7.0.repo << 'EOF'
            [mongodb-org-7.0]
            name=MongoDB Repository
            baseurl=https://repo.mongodb.org/yum/amazon/2/mongodb-org/7.0/x86_64/
            gpgcheck=1
            enabled=1
            gpgkey=https://www.mongodb.org/static/pgp/server-7.0.asc
            EOF
            yum install -y mongodb-mongosh
            
            # Criar usu√°rio do aluno
            useradd -m -s /bin/bash ${PrefixoAluno}02
            echo "${PrefixoAluno}02 ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
            
            # Copiar chave SSH do ec2-user para o aluno (permite SSH direto)
            mkdir -p /home/${PrefixoAluno}02/.ssh
            cp /home/ec2-user/.ssh/authorized_keys /home/${PrefixoAluno}02/.ssh/authorized_keys
            chown -R ${PrefixoAluno}02:${PrefixoAluno}02 /home/${PrefixoAluno}02/.ssh
            chmod 700 /home/${PrefixoAluno}02/.ssh
            chmod 600 /home/${PrefixoAluno}02/.ssh/authorized_keys
            
            # Instalar Node.js
            curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
            yum install -y nodejs
            
            # Instalar Python 3 e pip
            yum install -y python3 python3-pip
            
            # Instalar Terraform
            yum install -y yum-utils
            yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
            yum install -y terraform
            
            # Configurar AWS CLI para o aluno
            sudo -u ${PrefixoAluno}02 aws configure set aws_access_key_id ${AccessKey}
            sudo -u ${PrefixoAluno}02 aws configure set aws_secret_access_key ${SecretKey}
            sudo -u ${PrefixoAluno}02 aws configure set default.region ${AWS::Region}
            sudo -u ${PrefixoAluno}02 aws configure set default.output json
            
            # Baixar certificado SSL do DocumentDB
            cd /home/${PrefixoAluno}02
            wget https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem
            chown ${PrefixoAluno}02:${PrefixoAluno}02 global-bundle.pem
            
            # Instalar depend√™ncias Python
            sudo -u ${PrefixoAluno}02 pip3 install --user boto3
            
            # Criar diret√≥rio para laborat√≥rios
            sudo -u ${PrefixoAluno}02 mkdir -p /home/${PrefixoAluno}02/documentdb-labs
            
            # Criar arquivo de boas-vindas com instru√ß√µes
            cat > /home/${PrefixoAluno}02/BEM-VINDO.txt << 'WELCOME'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë              BEM-VINDO AO CURSO DOCUMENTDB                   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Ol√° ${PrefixoAluno}02!

Seu ambiente est√° configurado e pronto para uso.

üìã INFORMA√á√ïES DO AMBIENTE:
  - Usu√°rio Linux: ${PrefixoAluno}02
  - Usu√°rio AWS IAM: ${AWS::StackName}-${PrefixoAluno}02
  - Regi√£o AWS: ${AWS::Region}
  - Chave SSH: ${KeyPairName}

üîß FERRAMENTAS INSTALADAS:
  ‚úì AWS CLI (j√° configurado com suas credenciais)
  ‚úì MongoDB Shell (mongosh)
  ‚úì Node.js 18.x
  ‚úì Python 3 + pip
  ‚úì Terraform
  ‚úì Git

üìÅ DIRET√ìRIOS:
  - Laborat√≥rios: ~/documentdb-labs
  - Certificado SSL: ~/global-bundle.pem

üöÄ PRIMEIROS PASSOS:
  1. Teste o AWS CLI:
     aws sts get-caller-identity

  2. Liste recursos dispon√≠veis:
     aws docdb describe-db-clusters

  3. Acesse o diret√≥rio de labs:
     cd ~/documentdb-labs

üí° DICAS:
  - Suas credenciais AWS j√° est√£o configuradas
  - Use 'mongosh' para conectar ao DocumentDB
  - O certificado SSL est√° em ~/global-bundle.pem

üìö DOCUMENTA√á√ÉO:
  - AWS DocumentDB: https://docs.aws.amazon.com/documentdb/
  - MongoDB Shell: https://docs.mongodb.com/mongodb-shell/

Bom curso! üéì
WELCOME
            
            chown ${PrefixoAluno}02:${PrefixoAluno}02 /home/${PrefixoAluno}02/BEM-VINDO.txt
            
            # Criar arquivo .bashrc customizado
            cat >> /home/${PrefixoAluno}02/.bashrc << 'BASHRC'

# Customiza√ß√µes do Curso DocumentDB
export PS1='\[\033[01;32m\]\u@documentdb-lab\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '

# Aliases √∫teis
alias ll='ls -lah'
alias labs='cd ~/documentdb-labs'
alias awsid='aws sts get-caller-identity'

# Mostrar boas-vindas no primeiro login
if [ -f ~/BEM-VINDO.txt ] && [ ! -f ~/.welcome_shown ]; then
    cat ~/BEM-VINDO.txt
    touch ~/.welcome_shown
fi

echo ""
echo "üí° Digite 'cat ~/BEM-VINDO.txt' para ver as informa√ß√µes do ambiente"
echo ""
BASHRC
            
            chown ${PrefixoAluno}02:${PrefixoAluno}02 /home/${PrefixoAluno}02/.bashrc
            
            # Ajustar permiss√µes
            chown -R ${PrefixoAluno}02:${PrefixoAluno}02 /home/${PrefixoAluno}02/
            
            # Marcar setup como completo
            echo "Setup completo em $(date)" > /home/${PrefixoAluno}02/setup-complete.txt
            chown ${PrefixoAluno}02:${PrefixoAluno}02 /home/${PrefixoAluno}02/setup-complete.txt
          - AccessKey: !Ref Aluno02AccessKey
            SecretKey: !GetAtt Aluno02AccessKey.SecretAccessKey
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}02-instance'

Outputs:
  SecurityGroupDocumentDB:
    Description: 'Security Group ID para DocumentDB'
    Value: !Ref DocumentDBSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-DocumentDB-SG'

  LabsBucketName:
    Description: 'Nome do bucket S3'
    Value: !Ref LabsBucket

  Aluno01Info:
    Description: 'IP e credenciais do Aluno 01'
    Value: !Sub |
      IP: ${Aluno01Instance.PublicIp}
      IAM User: ${Aluno01User}
      Console Password: Extractta@2026
      SSH Direto: ssh -i ${KeyPairName}.pem ${PrefixoAluno}01@${Aluno01Instance.PublicIp}
      SSH via ec2-user: ssh -i ${KeyPairName}.pem ec2-user@${Aluno01Instance.PublicIp}

  Aluno02Info:
    Description: 'IP e credenciais do Aluno 02'
    Value: !Sub |
      IP: ${Aluno02Instance.PublicIp}
      IAM User: ${Aluno02User}
      Console Password: Extractta@2026
      SSH Direto: ssh -i ${KeyPairName}.pem ${PrefixoAluno}02@${Aluno02Instance.PublicIp}
      SSH via ec2-user: ssh -i ${KeyPairName}.pem ec2-user@${Aluno02Instance.PublicIp}

  ConsoleLoginURL:
    Description: 'URL para login no console AWS'
    Value: !Sub 'https://${AWS::AccountId}.signin.aws.amazon.com/console'

  ConsolePasswordSecretName:
    Description: 'Nome do secret contendo a senha do console'
    Value: !Ref ConsolePasswordSecret
    Export:
      Name: !Sub '${AWS::StackName}-ConsolePassword-Secret'

  InstrucoesConexao:
    Description: 'Como conectar as instancias'
    Value: !Sub |
      === ACESSO AO CONSOLE AWS ===
      URL: https://${AWS::AccountId}.signin.aws.amazon.com/console
      Senha: Armazenada no Secrets Manager
      
      Para recuperar a senha:
      aws secretsmanager get-secret-value --secret-id ${ConsolePasswordSecret} --query SecretString --output text | jq -r .password
      
      === ACESSO SSH ===
      Chave SSH: ${KeyPairName}.pem
      
      Op√ß√£o 1 - SSH Direto (Recomendado):
      ssh -i ${KeyPairName}.pem ${PrefixoAluno}XX@IP-PUBLICO
      
      Op√ß√£o 2 - Via ec2-user:
      ssh -i ${KeyPairName}.pem ec2-user@IP-PUBLICO
      sudo su - ${PrefixoAluno}XX
      
      AWS CLI j√° configurado!