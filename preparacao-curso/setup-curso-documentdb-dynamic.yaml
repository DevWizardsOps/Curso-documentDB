AWSTemplateFormatVersion: '2010-09-09'
Description: 'Ambiente para Curso DocumentDB - Instancias EC2 + Usuarios IAM'

Parameters:
  NumeroAlunos:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 20
    Description: 'Numero de alunos (1-20)'
    
  PrefixoAluno:
    Type: String
    Default: 'aluno'
    Description: 'Prefixo para nomes dos alunos'
    
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: 'VPC onde criar as instancias'
    
  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: 'Subnet publica para as instancias'
    
  AllowedCIDR:
    Type: String
    Default: '0.0.0.0/0'
    Description: 'CIDR permitido para SSH'
    
  KeyPairName:
    Type: String
    Description: 'Nome da chave SSH existente (a mesma sera usada para todas as instancias)'
    
  ConsolePasswordSecret:
    Type: String
    Description: 'Nome do secret no Secrets Manager contendo a senha do console'
    
  LabsBucketName:
    Type: String
    Description: 'Nome do bucket S3 para scripts e labs (ja deve existir)'

Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-0c02fb55956c7d316
    us-east-2:
      AMI: ami-0807bd3aff0ae7273
    us-west-1:
      AMI: ami-0d9858aa3c6322f73
    us-west-2:
      AMI: ami-008fe2fc65df48dac
    eu-west-1:
      AMI: ami-01dd271720c1ba44f
    eu-central-1:
      AMI: ami-0f454ec961da9a046
    sa-east-1:
      AMI: ami-0c820c196a818d66a

Conditions:
  CreateAluno01: !Not [!Equals [!Ref NumeroAlunos, 0]]
  CreateAluno02: !Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1]]]
  CreateAluno03: !Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2]]]
  CreateAluno04: !Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3]]]
  CreateAluno05: !Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4]]]
  CreateAluno06: !Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5]]]
  CreateAluno07: !Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6]]]
  CreateAluno08: !Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7]]]
  CreateAluno09: !Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7], !Equals [!Ref NumeroAlunos, 8]]]
  CreateAluno10: !Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7], !Equals [!Ref NumeroAlunos, 8], !Equals [!Ref NumeroAlunos, 9]]]
  CreateAluno11: !And [!Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7], !Equals [!Ref NumeroAlunos, 8], !Equals [!Ref NumeroAlunos, 9]]], !Not [!Or [!Equals [!Ref NumeroAlunos, 10]]]]
  CreateAluno12: !And [!Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7], !Equals [!Ref NumeroAlunos, 8], !Equals [!Ref NumeroAlunos, 9]]], !Not [!Or [!Equals [!Ref NumeroAlunos, 10], !Equals [!Ref NumeroAlunos, 11]]]]
  CreateAluno13: !And [!Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7], !Equals [!Ref NumeroAlunos, 8], !Equals [!Ref NumeroAlunos, 9]]], !Not [!Or [!Equals [!Ref NumeroAlunos, 10], !Equals [!Ref NumeroAlunos, 11], !Equals [!Ref NumeroAlunos, 12]]]]
  CreateAluno14: !And [!Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7], !Equals [!Ref NumeroAlunos, 8], !Equals [!Ref NumeroAlunos, 9]]], !Not [!Or [!Equals [!Ref NumeroAlunos, 10], !Equals [!Ref NumeroAlunos, 11], !Equals [!Ref NumeroAlunos, 12], !Equals [!Ref NumeroAlunos, 13]]]]
  CreateAluno15: !And [!Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7], !Equals [!Ref NumeroAlunos, 8], !Equals [!Ref NumeroAlunos, 9]]], !Not [!Or [!Equals [!Ref NumeroAlunos, 10], !Equals [!Ref NumeroAlunos, 11], !Equals [!Ref NumeroAlunos, 12], !Equals [!Ref NumeroAlunos, 13], !Equals [!Ref NumeroAlunos, 14]]]]
  CreateAluno16: !And [!Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7], !Equals [!Ref NumeroAlunos, 8], !Equals [!Ref NumeroAlunos, 9]]], !Not [!Or [!Equals [!Ref NumeroAlunos, 10], !Equals [!Ref NumeroAlunos, 11], !Equals [!Ref NumeroAlunos, 12], !Equals [!Ref NumeroAlunos, 13], !Equals [!Ref NumeroAlunos, 14], !Equals [!Ref NumeroAlunos, 15]]]]
  CreateAluno17: !And [!Not [!Or [!Equals [!Ref NumeroAlunos, 0], !Equals [!Ref NumeroAlunos, 1], !Equals [!Ref NumeroAlunos, 2], !Equals [!Ref NumeroAlunos, 3], !Equals [!Ref NumeroAlunos, 4], !Equals [!Ref NumeroAlunos, 5], !Equals [!Ref NumeroAlunos, 6], !Equals [!Ref NumeroAlunos, 7], !Equals [!Ref NumeroAlunos, 8], !Equals [!Ref NumeroAlunos, 9]]], !Not [!Or [!Equals [!Ref NumeroAlunos, 10], !Equals [!Ref NumeroAlunos, 11], !Equals [!Ref NumeroAlunos, 12], !Equals [!Ref NumeroAlunos, 13], !Equals [!Ref NumeroAlunos, 14], !Equals [!Ref NumeroAlunos, 15], !Equals [!Ref NumeroAlunos, 16]]]]

Resources:
  # Security Group para alunos
  AlunosSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-alunos-sg'
      GroupDescription: 'Security Group para instancias dos alunos'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedCIDR
          Description: 'SSH access'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-alunos-sg'

  # Security Group para DocumentDB
  DocumentDBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-documentdb-sg'
      GroupDescription: 'Security Group para DocumentDB'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 27017
          ToPort: 27017
          SourceSecurityGroupId: !Ref AlunosSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-documentdb-sg'

  # IAM Group para alunos
  CursoDocumentDBGroup:
    Type: AWS::IAM::Group
    Properties:
      GroupName: !Sub '${AWS::StackName}-students'
      Policies:
        - PolicyName: DocumentDBCoursePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # DocumentDB Elastic - Acesso completo (serviço elastic clusters)
              - Effect: Allow
                Action: 'docdb-elastic:*'
                Resource: '*'
              
              # RDS - Criação/modificação de instâncias COM restrição de classe (controle de custos)
              - Effect: Allow
                Action:
                  - 'rds:CreateDBInstance'
                  - 'rds:ModifyDBInstance'
                Resource: '*'
                Condition:
                  StringLike:
                    'rds:DatabaseClass':
                      - 'db.t3.medium'
                      - 'db.t3.large'
                      - 'db.t3.xlarge'
                      - 'db.r5.large'
                      - 'db.r5.xlarge'
              
              # RDS - Todas as outras operações SEM restrições
              - Effect: Allow
                Action: 'rds:*'
                Resource: '*'
              
              # EC2 - Consultas e gerenciamento (sem restrições de leitura)
              - Effect: Allow
                Action:
                  - 'ec2:*'
                Resource: '*'
              
              # EC2 - RunInstances com restrição de tipo de instância (família t3 até xlarge)
              - Effect: Allow
                Action: 'ec2:RunInstances'
                Resource: '*'
                Condition:
                  StringLike:
                    'ec2:InstanceType':
                      - 't3.nano'
                      - 't3.micro'
                      - 't3.small'
                      - 't3.medium'
                      - 't3.large'
                      - 't3.xlarge'
              
              # CloudWatch - Acesso completo (sem restrições para treinamento)
              - Effect: Allow
                Action: 'cloudwatch:*'
                Resource: '*'
              
              # CloudWatch Logs - Acesso completo (sem restrições para treinamento)
              - Effect: Allow
                Action: 'logs:*'
                Resource: '*'
              
              # S3 - Buckets do curso e backups dos alunos
              - Effect: Allow
                Action:
                  - 's3:CreateBucket'
                  - 's3:ListBucket'
                  - 's3:GetObject'
                  - 's3:PutObject'
                  - 's3:DeleteObject'
                  - 's3:GetBucketLocation'
                  - 's3:PutBucketVersioning'
                  - 's3:GetBucketVersioning'
                  - 's3:PutLifecycleConfiguration'
                  - 's3:GetLifecycleConfiguration'
                  - 's3:PutBucketPolicy'
                  - 's3:GetBucketPolicy'
                  - 's3:ListAllMyBuckets'
                Resource: 
                  - !Sub 'arn:aws:s3:::${AWS::StackName}-*'
                  - !Sub 'arn:aws:s3:::${AWS::StackName}-*/*'
                  - 'arn:aws:s3:::*-docdb-backups-*'
                  - 'arn:aws:s3:::*-docdb-backups-*/*'
                  - 'arn:aws:s3:::*-lab-*'
                  - 'arn:aws:s3:::*-lab-*/*'
              
              # EventBridge - Acesso completo (sem restrições para treinamento)
              - Effect: Allow
                Action: 'events:*'
                Resource: '*'
              
              # Lambda - Funcoes basicas para automacao
              - Effect: Allow
                Action:
                  - 'lambda:CreateFunction'
                  - 'lambda:DeleteFunction'
                  - 'lambda:InvokeFunction'
                  - 'lambda:UpdateFunctionCode'
                  - 'lambda:UpdateFunctionConfiguration'
                  - 'lambda:GetFunction'
                  - 'lambda:ListFunctions'
                Resource: !Sub 'arn:aws:lambda:*:${AWS::AccountId}:function:${AWS::StackName}-*'
              
              # SNS - Acesso completo (sem restrições para treinamento)
              - Effect: Allow
                Action: 'sns:*'
                Resource: '*'
              
              # CloudTrail - Auditoria e compliance (Modulo 3)
              - Effect: Allow
                Action:
                  - 'cloudtrail:*'
                Resource: '*'
              
              # KMS - Acesso completo (sem restrições para treinamento)
              - Effect: Allow
                Action: 'kms:*'
                Resource: '*'
              
              # STS - Identificacao do usuario
              - Effect: Allow
                Action: 'sts:GetCallerIdentity'
                Resource: '*'

  # IAM Role para instancias EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: S3SetupScriptAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:ListBucket'
                Resource:
                  - !Sub 'arn:aws:s3:::${LabsBucketName}'
                  - !Sub 'arn:aws:s3:::${LabsBucketName}/*'

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role


  # Recursos do Aluno 01
  Aluno01User:
    Condition: CreateAluno01
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}01'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno01AccessKey:
    Condition: CreateAluno01
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno01User

  Aluno01Instance:
    Condition: CreateAluno01
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}01" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno01AccessKey
            SecretKey: !GetAtt Aluno01AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}01-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 02
  Aluno02User:
    Condition: CreateAluno02
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}02'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno02AccessKey:
    Condition: CreateAluno02
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno02User

  Aluno02Instance:
    Condition: CreateAluno02
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}02" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno02AccessKey
            SecretKey: !GetAtt Aluno02AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}02-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 03
  Aluno03User:
    Condition: CreateAluno03
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}03'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno03AccessKey:
    Condition: CreateAluno03
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno03User

  Aluno03Instance:
    Condition: CreateAluno03
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}03" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno03AccessKey
            SecretKey: !GetAtt Aluno03AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}03-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 04
  Aluno04User:
    Condition: CreateAluno04
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}04'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno04AccessKey:
    Condition: CreateAluno04
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno04User

  Aluno04Instance:
    Condition: CreateAluno04
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}04" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno04AccessKey
            SecretKey: !GetAtt Aluno04AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}04-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 05
  Aluno05User:
    Condition: CreateAluno05
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}05'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno05AccessKey:
    Condition: CreateAluno05
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno05User

  Aluno05Instance:
    Condition: CreateAluno05
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}05" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno05AccessKey
            SecretKey: !GetAtt Aluno05AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}05-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 06
  Aluno06User:
    Condition: CreateAluno06
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}06'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno06AccessKey:
    Condition: CreateAluno06
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno06User

  Aluno06Instance:
    Condition: CreateAluno06
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}06" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno06AccessKey
            SecretKey: !GetAtt Aluno06AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}06-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 07
  Aluno07User:
    Condition: CreateAluno07
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}07'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno07AccessKey:
    Condition: CreateAluno07
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno07User

  Aluno07Instance:
    Condition: CreateAluno07
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}07" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno07AccessKey
            SecretKey: !GetAtt Aluno07AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}07-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 08
  Aluno08User:
    Condition: CreateAluno08
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}08'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno08AccessKey:
    Condition: CreateAluno08
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno08User

  Aluno08Instance:
    Condition: CreateAluno08
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}08" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno08AccessKey
            SecretKey: !GetAtt Aluno08AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}08-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 09
  Aluno09User:
    Condition: CreateAluno09
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}09'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno09AccessKey:
    Condition: CreateAluno09
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno09User

  Aluno09Instance:
    Condition: CreateAluno09
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}09" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno09AccessKey
            SecretKey: !GetAtt Aluno09AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}09-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 10
  Aluno10User:
    Condition: CreateAluno10
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}10'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno10AccessKey:
    Condition: CreateAluno10
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno10User

  Aluno10Instance:
    Condition: CreateAluno10
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}10" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno10AccessKey
            SecretKey: !GetAtt Aluno10AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}10-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 11
  Aluno11User:
    Condition: CreateAluno11
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}11'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno11AccessKey:
    Condition: CreateAluno11
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno11User

  Aluno11Instance:
    Condition: CreateAluno11
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}11" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno11AccessKey
            SecretKey: !GetAtt Aluno11AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}11-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 12
  Aluno12User:
    Condition: CreateAluno12
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}12'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno12AccessKey:
    Condition: CreateAluno12
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno12User

  Aluno12Instance:
    Condition: CreateAluno12
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}12" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno12AccessKey
            SecretKey: !GetAtt Aluno12AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}12-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 13
  Aluno13User:
    Condition: CreateAluno13
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}13'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno13AccessKey:
    Condition: CreateAluno13
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno13User

  Aluno13Instance:
    Condition: CreateAluno13
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}13" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno13AccessKey
            SecretKey: !GetAtt Aluno13AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}13-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 14
  Aluno14User:
    Condition: CreateAluno14
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}14'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno14AccessKey:
    Condition: CreateAluno14
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno14User

  Aluno14Instance:
    Condition: CreateAluno14
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}14" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno14AccessKey
            SecretKey: !GetAtt Aluno14AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}14-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 15
  Aluno15User:
    Condition: CreateAluno15
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}15'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno15AccessKey:
    Condition: CreateAluno15
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno15User

  Aluno15Instance:
    Condition: CreateAluno15
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}15" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno15AccessKey
            SecretKey: !GetAtt Aluno15AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}15-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 16
  Aluno16User:
    Condition: CreateAluno16
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}16'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno16AccessKey:
    Condition: CreateAluno16
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno16User

  Aluno16Instance:
    Condition: CreateAluno16
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}16" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno16AccessKey
            SecretKey: !GetAtt Aluno16AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}16-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

  # Recursos do Aluno 17
  Aluno17User:
    Condition: CreateAluno17
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${AWS::StackName}-${PrefixoAluno}17'
      Groups:
        - !Ref CursoDocumentDBGroup
      LoginProfile:
        Password: !Sub '{{resolve:secretsmanager:${ConsolePasswordSecret}:SecretString:password}}'
        PasswordResetRequired: false

  Aluno17AccessKey:
    Condition: CreateAluno17
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref Aluno17User

  Aluno17Instance:
    Condition: CreateAluno17
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref AlunosSecurityGroup
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub 
          - |
            #!/bin/bash
            # Aguardar IAM instance profile estar disponível (máximo 30s)
            for i in {1..30}; do
              if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ > /dev/null 2>&1; then
                break
              fi
              sleep 1
            done
            
            # Baixar e executar script de setup do S3
            aws s3 cp s3://${BucketName}/scripts/setup-aluno.sh /tmp/setup-aluno.sh
            chmod +x /tmp/setup-aluno.sh
            /tmp/setup-aluno.sh "${PrefixoAluno}17" "${AWS::Region}" "${AccessKey}" "${SecretKey}" >> /var/log/setup-aluno.log 2>&1
          - AccessKey: !Ref Aluno17AccessKey
            SecretKey: !GetAtt Aluno17AccessKey.SecretAccessKey
            PrefixoAluno: !Ref PrefixoAluno
            BucketName: !Ref LabsBucketName
      Tags:
        - Key: Name
          Value: !Sub '${PrefixoAluno}17-instance'
        - Key: Purpose
          Value: 'Curso DocumentDB'

Outputs:
  StackName:
    Description: 'Nome da Stack'
    Value: !Ref AWS::StackName
    
  Regiao:
    Description: 'Regiao AWS'
    Value: !Ref AWS::Region
    
  AccountId:
    Description: 'Account ID'
    Value: !Ref AWS::AccountId
    
  SecurityGroupDocumentDB:
    Description: 'Security Group ID para DocumentDB'
    Value: !Ref DocumentDBSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-DocumentDB-SG'

  LabsBucketName:
    Description: 'Nome do bucket S3 para labs'
    Value: !Ref LabsBucketName
  
  ConsolePasswordSecret:
    Description: 'Nome do secret contendo a senha do console'
    Value: !Ref ConsolePasswordSecret
    Export:
      Name: !Sub '${AWS::StackName}-ConsolePassword-Secret'
      
  SecretsManagerURL:
    Description: 'Link para o Secrets Manager'
    Value: !Sub 'https://console.aws.amazon.com/secretsmanager/home?region=${AWS::Region}#!/secret?name=${ConsolePasswordSecret}'
    
  KeyPairName:
    Description: 'Nome da chave SSH'
    Value: !Ref KeyPairName

  Aluno01IP:
    Condition: CreateAluno01
    Description: 'IP publico do Aluno 01'
    Value: !GetAtt Aluno01Instance.PublicIp

  Aluno02IP:
    Condition: CreateAluno02
    Description: 'IP publico do Aluno 02'
    Value: !GetAtt Aluno02Instance.PublicIp

  Aluno03IP:
    Condition: CreateAluno03
    Description: 'IP publico do Aluno 03'
    Value: !GetAtt Aluno03Instance.PublicIp

  Aluno04IP:
    Condition: CreateAluno04
    Description: 'IP publico do Aluno 04'
    Value: !GetAtt Aluno04Instance.PublicIp

  Aluno05IP:
    Condition: CreateAluno05
    Description: 'IP publico do Aluno 05'
    Value: !GetAtt Aluno05Instance.PublicIp

  Aluno06IP:
    Condition: CreateAluno06
    Description: 'IP publico do Aluno 06'
    Value: !GetAtt Aluno06Instance.PublicIp

  Aluno07IP:
    Condition: CreateAluno07
    Description: 'IP publico do Aluno 07'
    Value: !GetAtt Aluno07Instance.PublicIp

  Aluno08IP:
    Condition: CreateAluno08
    Description: 'IP publico do Aluno 08'
    Value: !GetAtt Aluno08Instance.PublicIp

  Aluno09IP:
    Condition: CreateAluno09
    Description: 'IP publico do Aluno 09'
    Value: !GetAtt Aluno09Instance.PublicIp

  Aluno10IP:
    Condition: CreateAluno10
    Description: 'IP publico do Aluno 10'
    Value: !GetAtt Aluno10Instance.PublicIp

  Aluno11IP:
    Condition: CreateAluno11
    Description: 'IP publico do Aluno 11'
    Value: !GetAtt Aluno11Instance.PublicIp

  Aluno12IP:
    Condition: CreateAluno12
    Description: 'IP publico do Aluno 12'
    Value: !GetAtt Aluno12Instance.PublicIp

  Aluno13IP:
    Condition: CreateAluno13
    Description: 'IP publico do Aluno 13'
    Value: !GetAtt Aluno13Instance.PublicIp

  Aluno14IP:
    Condition: CreateAluno14
    Description: 'IP publico do Aluno 14'
    Value: !GetAtt Aluno14Instance.PublicIp

  Aluno15IP:
    Condition: CreateAluno15
    Description: 'IP publico do Aluno 15'
    Value: !GetAtt Aluno15Instance.PublicIp

  Aluno16IP:
    Condition: CreateAluno16
    Description: 'IP publico do Aluno 16'
    Value: !GetAtt Aluno16Instance.PublicIp

  Aluno17IP:
    Condition: CreateAluno17
    Description: 'IP publico do Aluno 17'
    Value: !GetAtt Aluno17Instance.PublicIp

